---
title: "Communicating compile-time expressions from R to C++ in Rmarkdown"
author: "Edger Sterjo"
date: 2020-06-20
categories: ["C++", "R"]
tags: ["metaprogramming", "rmarkdown", "mcmc", "eigen", "c++", "rcpp", "r"]
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>In this short post we give a simple illustrative example of how data generated by R code can be used by compiled languages such as C++ at compile time, instead of run-time, inside Rmarkdown.</p>
<p>A word of warning before we go further. It’s easy to overdo it when it comes to metaprogramming/code generation like this. Personally I prefer to use less of it than more of it in production examples. This is just a fun example to learn from.</p>
</div>
<div id="using-other-languages-in-rmarkdown" class="section level2">
<h2>Using other languages in Rmarkdown</h2>
<p>Out of the box Rmarkdown can work with the following languages assuming a proper back-end is available:</p>
<pre class="r"><code>names(knitr::knit_engines$get())</code></pre>
<pre><code>##  [1] &quot;awk&quot;         &quot;bash&quot;        &quot;coffee&quot;      &quot;gawk&quot;        &quot;groovy&quot;     
##  [6] &quot;haskell&quot;     &quot;lein&quot;        &quot;mysql&quot;       &quot;node&quot;        &quot;octave&quot;     
## [11] &quot;perl&quot;        &quot;psql&quot;        &quot;Rscript&quot;     &quot;ruby&quot;        &quot;sas&quot;        
## [16] &quot;scala&quot;       &quot;sed&quot;         &quot;sh&quot;          &quot;stata&quot;       &quot;zsh&quot;        
## [21] &quot;highlight&quot;   &quot;Rcpp&quot;        &quot;tikz&quot;        &quot;dot&quot;         &quot;c&quot;          
## [26] &quot;fortran&quot;     &quot;fortran95&quot;   &quot;asy&quot;         &quot;cat&quot;         &quot;asis&quot;       
## [31] &quot;stan&quot;        &quot;block&quot;       &quot;block2&quot;      &quot;js&quot;          &quot;css&quot;        
## [36] &quot;sql&quot;         &quot;go&quot;          &quot;python&quot;      &quot;julia&quot;       &quot;sass&quot;       
## [41] &quot;scss&quot;        &quot;theorem&quot;     &quot;lemma&quot;       &quot;corollary&quot;   &quot;proposition&quot;
## [46] &quot;conjecture&quot;  &quot;definition&quot;  &quot;example&quot;     &quot;exercise&quot;    &quot;proof&quot;      
## [51] &quot;remark&quot;      &quot;solution&quot;</code></pre>
<p>Although we can use R’s native foreign function interface to call compiled code, for C++ a higher level alternative is to use <a href="https://cran.r-project.org/web/packages/Rcpp/index.html">Rcpp</a>. In Rmarkdown we can <a href="https://bookdown.org/yihui/rmarkdown/language-engines.html#rcpp">compile C++ code chunks using Rcpp and export the compiled functions to be available for use in R</a>.</p>
<p>As a canonical example, we can compile the following code</p>
<pre class="cpp"><code>#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector timesTwo(NumericVector x) 
{
    return x * 2;
}</code></pre>
<p>and use the exported function in R</p>
<pre class="r"><code>timesTwo(1:10)</code></pre>
<pre><code>##  [1]  2  4  6  8 10 12 14 16 18 20</code></pre>
</div>
<div id="registering-a-user-defined-language-engine-in-knitr" class="section level2">
<h2>Registering a user-defined language engine in Knitr</h2>
<p>We can also create <a href="https://bookdown.org/yihui/rmarkdown-cookbook/custom-engine.html">user-defined engines</a> to control exactly how the code chunk is sourced. To get an idea we can look at the default Rcpp engine used by knitr:</p>
<pre class="r"><code>knitr::knit_engines$get()$Rcpp</code></pre>
<pre><code>## function (options) 
## {
##     sourceCpp = getFromNamespace(&quot;sourceCpp&quot;, &quot;Rcpp&quot;)
##     code = one_string(options$code)
##     opts = options$engine.opts
##     cache = options$cache &amp;&amp; (&quot;cacheDir&quot; %in% names(formals(sourceCpp)))
##     if (cache) {
##         opts$cacheDir = paste(valid_path(options$cache.path, 
##             options$label), &quot;sourceCpp&quot;, sep = &quot;_&quot;)
##         opts$cleanupCacheDir = TRUE
##     }
##     if (!is.environment(opts$env)) 
##         opts$env = knit_global()
##     if (options$eval) {
##         message(&quot;Building shared library for Rcpp code chunk...&quot;)
##         do.call(sourceCpp, c(list(code = code), opts))
##     }
##     options$engine = &quot;cpp&quot;
##     engine_output(options, code, &quot;&quot;)
## }
## &lt;environment: namespace:knitr&gt;</code></pre>
<p>Using the default Rcpp engine above as a template we can define a new knitr engine for compiling C++. One that can read and make use of more dynamic R data in C++ before compilation and even dynamically create <code>Makevars</code> files to control compilation flags. First let’s include the knitr package and define a simple utility function:</p>
<pre class="r"><code>library(knitr)

# Concatenate list of strings using a delimiter of \n (similar 
# to what is used internally by knitr)
concat_lines = function(x, ...) paste(x, ..., collapse = &#39;\n&#39;)</code></pre>
<p>Next let’s take a crack at defining a new engine to compile C++ code. In this example we will pass the new data as part of the engine.opts field of the chunk:</p>
<pre class="r"><code>knit_engines$set(RcppFoo = function(options) {
    
    sourceCpp = getFromNamespace(&quot;sourceCpp&quot;, &quot;Rcpp&quot;)
    opts = options$engine.opts
    extra = opts$extra
    opts$extra = NULL
    
    ## Code is read as a list of strings, one list element per line
    ## Here we append extra code that may be defined in R to the 
    ## code written in the chunk
    code = c(extra, options$code)
    code = concat_lines(code)
    
    cache = options$cache &amp;&amp; (&quot;cacheDir&quot; %in% names(formals(sourceCpp)))
    if (cache) {
        opts$cacheDir = paste(valid_path(options$cache.path, 
            options$label), &quot;sourceCpp&quot;, sep = &quot;_&quot;)
        opts$cleanupCacheDir = TRUE
    }
    if (!is.environment(opts$env)) 
        opts$env = knit_global()

    if (options$eval) {    
        message(&quot;Building shared library for Rcpp code chunk...&quot;)
        do.call(sourceCpp, c(list(code = code), opts))
    }
    options$engine = &quot;cpp&quot;
    engine_output(options, 
                  options$code, 
                  paste(&quot;Added the lines:\n&quot;, concat_lines(extra), sep = &#39;\n&#39;))
})</code></pre>
<p>Next we test by creating some data in R and using that as a compile time constant in C++. Here we pass values of pi and e as static consts to C++.</p>
<pre class="r"><code>constants = list(
    paste(&#39;static const double Pi =&#39;, pi, &#39;;&#39;),
    paste(&#39;static const double Euler =&#39;, exp(1),&#39;;&#39;)
)</code></pre>
<p>This already highlights a danger as we don’t know exactly how R might convert these double precision floating point numbers to strings. Regardless, we proceed. To use the new engine we run the engine as <code>{RcppFoo test_chunk, engine.opts = list(extra = constants)}</code></p>
<pre class="cpp"><code>#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector timesFoo(NumericVector x) 
{
    return x * Pi + Euler;
}</code></pre>
<pre><code>## Added the lines:
## 
## static const double Pi = 3.14159265358979 ;
## static const double Euler = 2.71828182845905 ;</code></pre>
<pre class="r"><code>x = timesFoo(1:10)
print(x)</code></pre>
<pre><code>##  [1]  5.859874  9.001467 12.143060 15.284652 18.426245 21.567838 24.709430
##  [8] 27.851023 30.992616 34.134208</code></pre>
<p>We get <strong>basically</strong> the same result in R</p>
<pre class="r"><code>y = pi*(1:10)+exp(1)
print(y)</code></pre>
<pre><code>##  [1]  5.859874  9.001467 12.143060 15.284652 18.426245 21.567838 24.709430
##  [8] 27.851023 30.992616 34.134208</code></pre>
<p>But metaprogramming is dangerous as some loss of precision occurred with the doubles when converting to strings:</p>
<pre class="r"><code>print(x - y)</code></pre>
<pre><code>##  [1]  1.776357e-15  0.000000e+00 -3.552714e-15 -7.105427e-15 -1.065814e-14
##  [6] -1.421085e-14 -1.776357e-14 -1.776357e-14 -2.131628e-14 -2.842171e-14</code></pre>
</div>
